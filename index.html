<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>拡張版マンダラチャート生成（中心テーマファイル名対応）</title>
  <style>
    table {
      border-collapse: collapse;
      margin: 2px;
    }
    td {
      width: 60px;
      height: 60px;
      border: 1px solid #000;
      text-align: center;
      vertical-align: middle;
      font-size: 12px;
      cursor: pointer;
    }
    input, button {
      margin: 10px;
      display: block;
    }
    input[type="text"] {
      text-align: center;
    }
    .big-grid {
      display: grid;
      grid-template-columns: repeat(3, auto);
      grid-gap: 10px;
      justify-content: center;
    }
  </style>
</head>
<body>

<h1 style="text-align:center;">拡張版マンダラチャート生成アプリ</h1>

<div style="text-align:center;">
  <input type="text" id="centerTheme" placeholder="中心テーマを入力" />
  <button onclick="setCenter()">中心テーマセット</button>
  <button onclick="downloadMarkdown()">Markdown保存</button>
</div>

<div id="bigMandala" class="big-grid"></div>

<script>
// 9個のマンダラ（それぞれ9マス）
let mandalas = Array.from({length: 9}, () => Array(9).fill(""));

// 中央マンダラのサブマスと外側マンダラの対応マップ
const outerMap = [0, 1, 2, 3, 5, 6, 7, 8];

function renderBigMandala() {
  const bigDiv = document.getElementById('bigMandala');
  bigDiv.innerHTML = '';

  for (let m = 0; m < 9; m++) {
    const table = document.createElement('table');
    let index = 0;
    for (let i = 0; i < 3; i++) {
      const row = document.createElement('tr');
      for (let j = 0; j < 3; j++) {
        const cell = document.createElement('td');
        const currentMandala = m;
        const currentIndex = index;
        cell.innerText = mandalas[currentMandala][currentIndex];

        cell.onclick = function() {
          if (cell.querySelector('input')) return;
          const input = document.createElement('input');
          input.type = 'text';
          input.value = mandalas[currentMandala][currentIndex];
          input.style.width = "90%";
          input.style.fontSize = "12px";

          input.onblur = function() {
            saveInput(currentMandala, currentIndex, input.value);
          };

          input.onkeydown = function(e) {
            if (e.key === 'Enter') {
              saveInput(currentMandala, currentIndex, input.value);

              // 次のマスへ
              let nextIndex = currentIndex + 1;
              let nextMandala = currentMandala;

              while (true) {
                if (nextIndex >= 9) {
                  nextIndex = 0;
                  nextMandala++;
                  if (nextMandala >= 9) {
                    renderBigMandala(); // 全部終了
                    return;
                  }
                  if (nextMandala === 4) {
                    nextMandala++; // 中央マンダラはスキップ！
                  }
                }
                if (nextIndex === 4) {
                  nextIndex++; // 中心マススキップ
                  continue;
                }
                break;
              }

              renderBigMandala();

              // 少し待ってから次のセルクリック
              setTimeout(() => {
                const bigDiv = document.getElementById('bigMandala');
                const tables = bigDiv.querySelectorAll('table');
                const nextTable = tables[nextMandala];
                if (!nextTable) return;
                const nextCell = nextTable.querySelectorAll('td')[nextIndex];
                if (nextCell) {
                  nextCell.click();
                }
              }, 50);
            }
          };

          cell.innerHTML = '';
          cell.appendChild(input);
          input.focus();
        };

        row.appendChild(cell);
        index++;
      }
      table.appendChild(row);
    }
    bigDiv.appendChild(table);
  }
}

// 入力を保存し、外側マンダラに連携
function saveInput(mandalaIndex, cellIndex, value) {
  mandalas[mandalaIndex][cellIndex] = value;

  // 中央マンダラのサブテーマ入力時は外側に反映
  if (mandalaIndex === 4 && cellIndex !== 4) {
    const outerIdx = outerMap[cellIndex < 4 ? cellIndex : cellIndex - 1];
    mandalas[outerIdx][4] = value;
  }
}

// 中心テーマをセット
function setCenter() {
  const center = document.getElementById('centerTheme').value.trim();
  if (!center) {
    alert("中心テーマを入力してください！");
    return;
  }
  mandalas[4][4] = center; // 真ん中のマンダラの中心にセット
  renderBigMandala();
}

// Markdownファイル生成・ダウンロード
function downloadMarkdown() {
  let md = `# 拡張版マンダラチャート\n\n`;
  for (let m = 0; m < 9; m++) {
    md += `## マンダラ${m+1}\n`;
    md += `中心テーマ: ${mandalas[m][4]}\n\n`;
    md += "サブテーマ:\n";
    mandalas[m].forEach((item, index) => {
      if (index !== 4) md += `- ${item}\n`;
    });
    md += "\n";
  }

  // ファイル名に中心テーマを反映
  let centerTheme = mandalas[4][4] || "mandala"; // 中央マンダラの中心
  centerTheme = centerTheme.replace(/\s+/g, '_'); // スペースをアンダースコアに
  centerTheme = centerTheme.replace(/[^\w\u3000-\u303F\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]/g, ''); // 記号除去

  const filename = `mandara_${centerTheme}.md`;

  const blob = new Blob([md], { type: "text/markdown" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

// 初期描画
renderBigMandala();
</script>

</body>
</html>
